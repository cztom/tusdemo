/**
 * Minified by jsDelivr using Terser v5.15.1.
 * Original file: /npm/tus-js-client@3.0.1/lib.es5/node/urlStorage.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.canStoreURLs=exports.FileUrlStorage=void 0;var _fs=require("fs"),lockfile=_interopRequireWildcard(require("proper-lockfile")),_combineErrors=_interopRequireDefault(require("combine-errors"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(_getRequireWildcardCache=function(e){return e?r:t})(e)}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=_getRequireWildcardCache(t);if(r&&r.has(e))return r.get(e);var n={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var a=i?Object.getOwnPropertyDescriptor(e,o):null;a&&(a.get||a.set)?Object.defineProperty(n,o,a):n[o]=e[o]}return n.default=e,r&&r.set(e,n),n}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}var canStoreURLs=!0;exports.canStoreURLs=canStoreURLs;var FileUrlStorage=function(){function e(t){_classCallCheck(this,e),this.path=t}return _createClass(e,[{key:"findAllUploads",value:function(){var e=this;return new Promise((function(t,r){e._getItems("tus::",(function(e,n){e?r(e):t(n)}))}))}},{key:"findUploadsByFingerprint",value:function(e){var t=this;return new Promise((function(r,n){t._getItems("tus::".concat(e),(function(e,t){e?n(e):r(t)}))}))}},{key:"removeUpload",value:function(e){var t=this;return new Promise((function(r,n){t._removeItem(e,(function(e){e?n(e):r()}))}))}},{key:"addUpload",value:function(e,t){var r=this,n=Math.round(1e12*Math.random()),i="tus::".concat(e,"::").concat(n);return new Promise((function(e,n){r._setItem(i,t,(function(t){t?n(t):e(i)}))}))}},{key:"_setItem",value:function(e,t,r){var n=this;lockfile.lock(this.path,this._lockfileOptions()).then((function(i){r=n._releaseAndCb(i,r),n._getData((function(i,o){i?r(i):(o[e]=t,n._writeData(o,(function(e){return r(e)})))}))})).catch(r)}},{key:"_getItems",value:function(e,t){this._getData((function(r,n){if(r)t(r);else{var i=Object.keys(n).filter((function(t){return t.startsWith(e)})).map((function(e){var t=n[e];return t.urlStorageKey=e,t}));t(null,i)}}))}},{key:"_removeItem",value:function(e,t){var r=this;lockfile.lock(this.path,this._lockfileOptions()).then((function(n){t=r._releaseAndCb(n,t),r._getData((function(n,i){n?t(n):(delete i[e],r._writeData(i,(function(e){return t(e)})))}))})).catch(t)}},{key:"_lockfileOptions",value:function(){return{realpath:!1,retries:{retries:5,minTimeout:20}}}},{key:"_releaseAndCb",value:function(e,t){return function(r){r?e().then((function(){return t(r)})).catch((function(e){return t((0,_combineErrors.default)([r,e]))})):e().then(t).catch(t)}}},{key:"_writeData",value:function(e,t){(0,_fs.writeFile)(this.path,JSON.stringify(e),{encoding:"utf8",mode:432,flag:"w"},(function(e){return t(e)}))}},{key:"_getData",value:function(e){(0,_fs.readFile)(this.path,"utf8",(function(t,r){if(t)"ENOENT"===t.code?e(null,{}):e(t);else{try{r=r.trim().length?JSON.parse(r):{}}catch(t){return void e(t)}e(null,r)}}))}}]),e}();exports.FileUrlStorage=FileUrlStorage;
//# sourceMappingURL=/sm/39f070a61b34b23baf70b528311afd8e135b9b5abf701e335069deb2c4f6d753.map