/**
 * Minified by jsDelivr using Terser v5.15.1.
 * Original file: /npm/tus-js-client@3.0.1/lib/node/urlStorage.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{readFile,writeFile}from"fs";import*as lockfile from"proper-lockfile";import combineErrors from"combine-errors";export const canStoreURLs=!0;export class FileUrlStorage{constructor(t){this.path=t}findAllUploads(){return new Promise(((t,e)=>{this._getItems("tus::",((r,i)=>{r?e(r):t(i)}))}))}findUploadsByFingerprint(t){return new Promise(((e,r)=>{this._getItems(`tus::${t}`,((t,i)=>{t?r(t):e(i)}))}))}removeUpload(t){return new Promise(((e,r)=>{this._removeItem(t,(t=>{t?r(t):e()}))}))}addUpload(t,e){const r=`tus::${t}::${Math.round(1e12*Math.random())}`;return new Promise(((t,i)=>{this._setItem(r,e,(e=>{e?i(e):t(r)}))}))}_setItem(t,e,r){lockfile.lock(this.path,this._lockfileOptions()).then((i=>{r=this._releaseAndCb(i,r),this._getData(((i,s)=>{i?r(i):(s[t]=e,this._writeData(s,(t=>r(t))))}))})).catch(r)}_getItems(t,e){this._getData(((r,i)=>{if(r)return void e(r);const s=Object.keys(i).filter((e=>e.startsWith(t))).map((t=>{const e=i[t];return e.urlStorageKey=t,e}));e(null,s)}))}_removeItem(t,e){lockfile.lock(this.path,this._lockfileOptions()).then((r=>{e=this._releaseAndCb(r,e),this._getData(((r,i)=>{r?e(r):(delete i[t],this._writeData(i,(t=>e(t))))}))})).catch(e)}_lockfileOptions(){return{realpath:!1,retries:{retries:5,minTimeout:20}}}_releaseAndCb(t,e){return r=>{r?t().then((()=>e(r))).catch((t=>e(combineErrors([r,t])))):t().then(e).catch(e)}}_writeData(t,e){writeFile(this.path,JSON.stringify(t),{encoding:"utf8",mode:432,flag:"w"},(t=>e(t)))}_getData(t){readFile(this.path,"utf8",((e,r)=>{if(e)"ENOENT"===e.code?t(null,{}):t(e);else{try{r=r.trim().length?JSON.parse(r):{}}catch(e){return void t(e)}t(null,r)}}))}}
//# sourceMappingURL=/sm/2516e7f02af8e29e7bf05de669b70daa0223eadfc51401f02f635e963313ba57.map