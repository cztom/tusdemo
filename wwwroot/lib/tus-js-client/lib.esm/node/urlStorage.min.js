/**
 * Minified by jsDelivr using Terser v5.15.1.
 * Original file: /npm/tus-js-client@3.0.1/lib.esm/node/urlStorage.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}import{readFile,writeFile}from"fs";import*as lockfile from"proper-lockfile";import combineErrors from"combine-errors";export var canStoreURLs=!0;export var FileUrlStorage=function(){function e(t){_classCallCheck(this,e),this.path=t}return _createClass(e,[{key:"findAllUploads",value:function(){var e=this;return new Promise((function(t,n){e._getItems("tus::",(function(e,r){e?n(e):t(r)}))}))}},{key:"findUploadsByFingerprint",value:function(e){var t=this;return new Promise((function(n,r){t._getItems("tus::".concat(e),(function(e,t){e?r(e):n(t)}))}))}},{key:"removeUpload",value:function(e){var t=this;return new Promise((function(n,r){t._removeItem(e,(function(e){e?r(e):n()}))}))}},{key:"addUpload",value:function(e,t){var n=this,r=Math.round(1e12*Math.random()),i="tus::".concat(e,"::").concat(r);return new Promise((function(e,r){n._setItem(i,t,(function(t){t?r(t):e(i)}))}))}},{key:"_setItem",value:function(e,t,n){var r=this;lockfile.lock(this.path,this._lockfileOptions()).then((function(i){n=r._releaseAndCb(i,n),r._getData((function(i,o){i?n(i):(o[e]=t,r._writeData(o,(function(e){return n(e)})))}))})).catch(n)}},{key:"_getItems",value:function(e,t){this._getData((function(n,r){if(n)t(n);else{var i=Object.keys(r).filter((function(t){return t.startsWith(e)})).map((function(e){var t=r[e];return t.urlStorageKey=e,t}));t(null,i)}}))}},{key:"_removeItem",value:function(e,t){var n=this;lockfile.lock(this.path,this._lockfileOptions()).then((function(r){t=n._releaseAndCb(r,t),n._getData((function(r,i){r?t(r):(delete i[e],n._writeData(i,(function(e){return t(e)})))}))})).catch(t)}},{key:"_lockfileOptions",value:function(){return{realpath:!1,retries:{retries:5,minTimeout:20}}}},{key:"_releaseAndCb",value:function(e,t){return function(n){n?e().then((function(){return t(n)})).catch((function(e){return t(combineErrors([n,e]))})):e().then(t).catch(t)}}},{key:"_writeData",value:function(e,t){writeFile(this.path,JSON.stringify(e),{encoding:"utf8",mode:432,flag:"w"},(function(e){return t(e)}))}},{key:"_getData",value:function(e){readFile(this.path,"utf8",(function(t,n){if(t)"ENOENT"===t.code?e(null,{}):e(t);else{try{n=n.trim().length?JSON.parse(n):{}}catch(t){return void e(t)}e(null,n)}}))}}]),e}();
//# sourceMappingURL=/sm/29921aaaa9d3d2d9bde074143091fed25e704bfaf4c7b1bfbc4f7f108bfcf965.map